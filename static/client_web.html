<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªù T∆∞·ªõng Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #efe1c6 0%, #cab078 100%);
      margin: 0;
      padding: 10px;
      color: #222;
    }
    header { text-align: center; }
    h1 { margin: 6px 0; color:#8b0000; text-shadow: 1px 1px 3px #0002; }

    #loginView { text-align:center; margin-top: 20px; }
    #lobbyView { display: none; padding: 20px; max-width: 600px; margin: 20px auto; background: rgba(255,255,255,0.7); border-radius: 10px; }
    #gameView { display: none; }

    .layout { display:flex; gap:20px; justify-content:center; margin-top:10px; }
    .left { width: 660px; }
    .right { width: 300px; background: rgba(255,255,255,0.7); border-radius:10px; padding:12px; box-shadow:0 6px 16px rgba(0,0,0,0.15); }

    #playerList { list-style: none; padding: 0; }
    #playerList li {
      padding: 10px; background: #fff7e6; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;
    }
    #playerList button { background: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    #playerList button:disabled { background: #ccc; }

    #invitations { margin-top: 20px; }
    .invitation {
      padding: 10px; background: #dff0d8; border: 1px solid #c3e6cb; margin-bottom: 5px; border-radius: 5px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .invitation button { margin-left: 5px; }

    .board {
      display:grid;
      grid-template-columns: repeat(9, 70px);
      grid-template-rows: repeat(10, 70px);
      width: 630px;
      height: 700px;
      background-image: url('/static/banco.jpg');
      background-size: cover;
      border-radius: 16px;
      border: 8px solid #7a4f2b;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      position: relative;
      margin: auto;
      transition: transform 0.5s;
    }

    .cell { width:70px; height:70px; display:flex; justify-content:center; align-items:center; cursor:pointer; }

    .piece {
      width:62px; height:62px; display:flex; justify-content:center; align-items:center;
      border-radius:50%;
      box-shadow:
        inset 2px 2px 6px rgba(255,255,255,0.6),
        inset -3px -3px 6px rgba(0,0,0,0.3),
        0 3px 6px rgba(0,0,0,0.4);
      font-family: 'Noto Serif SC', serif;
      font-weight:800;
      font-size:28px;
      user-select:none;
      transition: transform .15s;
    }
    .piece--red {
      background: radial-gradient(circle at 30% 30%, #ffb5b5, #d23);
      color: #fff5f5;
      border: 2px solid gold;
    }
    .piece--black {
      background: radial-gradient(circle at 30% 30%, #f2f2f2, #555);
      color: #222;
      border: 2px solid #ccc;
    }
    .piece:hover { transform: scale(1.08); }
    .selected { outline: 3px solid gold; transform: scale(1.15); }

    .board--flipped { transform: rotate(180deg); }
    .board--flipped .piece { transform: rotate(-180deg); }
    .board--flipped .piece:hover { transform: rotate(-180deg) scale(1.08); }
    .board--flipped .selected { transform: rotate(-180deg) scale(1.15); }

    .controls { text-align:center; margin:8px 0; }
    .controls button {
      padding:8px 14px; border-radius:8px; border:none;
      background:#8b0000; color:white; cursor:pointer; font-weight:600;
    }

    .timer { text-align:center; font-weight:700; font-size:16px; margin:4px 0; }
    .timer.red { color:#c22; }
    .timer.black { color:#000; }
    .timer.active { font-size: 18px; text-shadow: 0 0 8px gold; }

    .thinking {
      text-align:center;
      font-size:14px;
      color:#444;
      margin-top:-4px;
    }

    #log { font-size:13px; max-height:300px; overflow:auto; background:#fff7e6; border-radius:6px; padding:6px; }
  </style>
</head>
<body>
  <header><h1>üéØ C·ªù T∆∞·ªõng Online</h1></header>

  <div id="loginView">
    <input id="player" value="Player1" placeholder="T√™n ng∆∞·ªùi ch∆°i" />
    <button onclick="connect()">V√†o S·∫£nh</button>
  </div>

  <div id="lobbyView">
    <h2>S·∫£nh ch·ªù</h2>
    <p>Ch√†o <b id="lobbyPlayerName"></b>.</p>
    <div id="invitations"></div>
    <h3>Ng∆∞·ªùi ch∆°i online</h3>
    <ul id="playerList"><li>ƒêang t·∫£i...</li></ul>
  </div>

  <div id="gameView">
    <div class="layout">
      <div class="left">
        <div class="status" id="status">ƒêang ch·ªù...</div>

        <div class="timer red" id="clock_red">üî¥ Red: 05:00</div>
        <div class="thinking" id="think_red">‚è≥ ƒêang suy nghƒ©: 0s</div>

        <div class="timer black" id="clock_black">‚ö´ Black: 05:00</div>
        <div class="thinking" id="think_black">‚è≥ ƒêang suy nghƒ©: 0s</div>

        <div class="board" id="board"></div>
      </div>
      <div class="right">
        <h3>L·ªãch s·ª≠ / H·ªá th·ªëng</h3>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    let ws=null, playerName=null, myColor=null;
    let clocks={red:300, black:300}, thinking={red:0, black:0}, turn="red", colors={};

    const boardDiv=document.getElementById("board");
    for(let i=0;i<90;i++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.onclick=()=>onCellClick(i);
      boardDiv.appendChild(cell);
    }

    function connect(){
      playerName=document.getElementById("player").value;
      if(!playerName){ alert("Vui l√≤ng nh·∫≠p t√™n"); return; }

      ws=new WebSocket("ws://localhost:8000/ws");
      ws.onopen=()=>{
        ws.send(JSON.stringify({type:"join_lobby", player:playerName}));
        document.getElementById("loginView").style.display="none";
        document.getElementById("lobbyView").style.display="block";
        document.getElementById("lobbyPlayerName").textContent=playerName;
      };
      ws.onmessage=e=>{
        const msg=JSON.parse(e.data);
        switch(msg.type){
          case "lobby_update": updateLobby(msg.players); break;
          case "challenge_received": showInvitation(msg.from_player); break;
          case "game_start":
            myColor=msg.color;
            document.getElementById("lobbyView").style.display="none";
            document.getElementById("gameView").style.display="block";
            boardDiv.classList.toggle("board--flipped", myColor==="black");
            log(`Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu. B·∫°n l√† ${myColor}.`);
            break;
          case "state":
            updateBoard(msg.state.board);
            turn=msg.turn;
            clocks=msg.clocks; thinking=msg.thinking; colors=msg.colors;
            updateTurn(); updateClocks();
            break;
          case "error": log("‚ö†Ô∏è "+msg.reason); break;
        }
      };
    }

    function updateLobby(players){
      const list=document.getElementById("playerList");
      list.innerHTML="";
      players.forEach(p=>{
        if(p===playerName) return;
        const li=document.createElement("li");
        li.textContent=p;
        const b=document.createElement("button");
        b.textContent="Th√°ch ƒë·∫•u";
        b.onclick=()=>ws.send(JSON.stringify({type:"challenge", target_player:p}));
        li.appendChild(b); list.appendChild(li);
      });
      if(list.innerHTML==="") list.innerHTML="<li>Kh√¥ng c√≥ ai kh√°c.</li>";
    }

    function showInvitation(from){
      const inv=document.getElementById("invitations");
      inv.innerHTML=`<div class="invitation">
      <span>${from} m·ªùi b·∫°n th√°ch ƒë·∫•u.</span>
      <div>
        <button onclick="acceptChallenge('${from}')">Ch·∫•p nh·∫≠n</button>
        <button onclick="declineChallenge('${from}')">T·ª´ ch·ªëi</button>
      </div></div>`;
    }
    function acceptChallenge(n){ ws.send(JSON.stringify({type:"challenge_accept", opponent_name:n})); document.getElementById("invitations").innerHTML=""; }
    function declineChallenge(n){ ws.send(JSON.stringify({type:"challenge_decline", opponent_name:n})); document.getElementById("invitations").innerHTML=""; }

    function getPieceColor(p){ return ['‰ø•','ÂÇå','Áõ∏','‰ªï','Â∏•','ÁÇÆ','ÂÖµ'].includes(p)?'red':'black'; }

    function updateBoard(b){
      const cells=document.getElementsByClassName("cell");
      for(let i=0;i<90;i++){ cells[i].innerHTML=""; }
      for(let y=0;y<10;y++){
        for(let x=0;x<9;x++){
          const idx=y*9+x;
          const p=b[y][x];
          if(p){
            const div=document.createElement("div");
            div.className="piece "+(getPieceColor(p)==='red'?'piece--red':'piece--black');
            div.textContent=p;
            let showIdx = idx;
            if(myColor==="black"){ showIdx = 89 - idx; }
            cells[showIdx].appendChild(div);
          }
        }
      }
    }

    function updateTurn(){
      const st=document.getElementById("status");
      const now=turn==="red"?"ƒê·ªè":"ƒêen";
      st.textContent=`üéØ L∆∞·ª£t c·ªßa: ${now}`;
      document.getElementById("clock_red").classList.toggle("active", turn==="red");
      document.getElementById("clock_black").classList.toggle("active", turn==="black");
    }

    function fmt(s){s=Math.max(0,s);let m=Math.floor(s/60),x=s%60;return `${String(m).padStart(2,"0")}:${String(x).padStart(2,"0")}`;}

    function updateClocks(){
      document.getElementById("clock_red").textContent=`üî¥ ƒê·ªè: ${fmt(clocks.red)}`;
      document.getElementById("clock_black").textContent=`‚ö´ ƒêen: ${fmt(clocks.black)}`;
      document.getElementById("think_red").textContent=`‚è≥ Suy nghƒ©: ${thinking.red}s`;
      document.getElementById("think_black").textContent=`‚è≥ Suy nghƒ©: ${thinking.black}s`;
    }

    let selected=null;
    function onCellClick(i){
      if(!myColor) return;
      let x,y;
      if(myColor==="black"){
        const flipped=89-i; y=Math.floor(flipped/9); x=flipped%9;
      } else {
        y=Math.floor(i/9); x=i%9;
      }
      const cell=document.getElementsByClassName("cell")[i];
      if(!selected && cell.innerHTML.trim()!==""){
        selected={x,y,i}; cell.firstChild.classList.add("selected");
      }else if(selected){
        ws.send(JSON.stringify({type:"move",move:{from:{x:selected.x,y:selected.y},to:{x,y}}}));
        document.getElementsByClassName("cell")[selected.i].firstChild.classList.remove("selected");
        selected=null;
      }
    }

    function log(t){const el=document.getElementById("log");el.innerHTML=`[${new Date().toLocaleTimeString()}] ${t}<br>`+el.innerHTML;}
  </script>
</body>
</html>
